%-*-coding: utf-8-*-
\startprefacepage
<<ВКонтакте>> - социальная сеть, большая часть которой разрабатывается на языке PHP, начиная с 2006 года.
В 2013 году суточная посещаемость ВКонтакте достигла почти 50 млн. пользователей \cite{kphp-vk-2013}, и социальная сеть столкнулась с проблемой обработки большого числа запросов.
Было принято решение о разработке нового инструмента для ускорения и уменьшения потребления памяти занимаемой работой PHP скрипта.
KPHP был спроектирован для ускорения, написанного кода, который транслировал PHP код в C++.
По факту, на тот момент, не было поддержки ООП и функционального стиля, но этого было достаточно, чтобы перевести сайт на KPHP, ускорив тем самым загрузку страниц почти в два раза.

С того времени было написано много нового кода, внутренняя инфраструктура развивалась, и возникала необходимость в поддержке нового синтаксиса и соответствующей функциональности.
В современном мире функциональное программирование занимает важную роль, благодаря которому увеличивается производительность программистов, а код становится более выразительным \cite{fp-matters}.
Хорошо структурированные программы легки в написании, отладки, чтении и предоставляют набор модулей, которые без труда могут быть использованы снова, что в свою очередь уменьшает стоимость доработок в будущем.
Функции высших порядков и анонимные функции улучшают модульность программ.
В KPHP существовала возможность передачи указателей на функции во встроенные методы, но нельзя было передавать указатели в произвольные функции и сохранять их в переменные.
Из-за этого приходилось писать громоздкий код, который было сложно поддерживать.

В связи с тем, что не было возможности в KPHP задания типа принимаемой функции приходилось обобщать возвращаемый тип таких функций, как \verb|array_map| до типа-суммы, что ухудшало производительность и увеличивало потребление памяти.
С появлением в языке объектов классов пропала возможность использования стандартных функций с массивом экземпляров классов, так как генерировать все возможные типы-суммы из пользовательских классов и примитивных типов не представляется возможным из-за их количества.
Данные проблемы будут описаны подробнее в первой главе.

Далее будет подробно рассмотрена поставленная задача и подходы, необходимые для успешной поддержки функций высших порядков и анонимных функций в языке KPHP.
Будет представлен созданный синтаксис для типизации внутренних функций высших порядков.
Увидим, что потеря типизации ухудшает статический анализ и увеличивает количество ошибок в коде.
Рассмотрим, как можно реализовать данную функциональность и не потерять в производительности.
Также будет приведен сравнительный анализ с другими инструментами позволяющими решать эту задачу, например HHVM4.2 \cite{hhvm} и PHP7.2 \cite{php7}, а также возможности для дальнейшего развития.
